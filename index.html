
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendário de Tarefas</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      padding: 20px;
    }
    .calendar {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header button {
      background-color: #007BFF;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .header button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      width: 14.2%;
      text-align: center;
      padding: 10px;
      border: 1px solid #ddd;
      position: relative;
    }
    th {
      background-color: #007BFF;
      color: white;
    }
    td.empty {
      background-color: #f9f9f9;
    }
    td.today {
      background-color: #ffeeba;
      border: 2px solid #ffc107;
      font-weight: bold;
    }
    td.has-task {
      background-color: #d4edda;
      border: 2px solid #28a745;
    }
    .tooltip {
      display: none;
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      white-space: pre-line;
      z-index: 10;
      font-size: 12px;
    }
    .task-form {
      margin-bottom: 20px;
    }
    .task-form input, .task-form select {
      padding: 5px;
      margin-right: 5px;
    }
    .task-form button {
      padding: 5px 10px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .task-form button:hover {
      background-color: #218838;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
    }
    .modal-content {
      background: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .close {
      color: red;
      font-size: 24px;
      cursor: pointer;
    }
    .task-item {
      border-bottom: 1px solid #ddd;
      padding: 8px 0;
    }
    .task-item:last-child {
      border: none;
    }
    .task-actions button {
      margin-left: 5px;
      padding: 3px 7px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .edit-btn {
      background-color: #ffc107;
      color: #000;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>
<body>

  <div class="calendar">
    <h1>Calendário de Tarefas</h1>

    <div class="task-form">
      <input type="date" id="taskDate" />
      <input type="time" id="taskTime" />
      <input type="text" id="taskDescription" placeholder="Descrição" />
      <select id="taskRecurring">
        <option value="none">Não recorrente</option>
        <option value="daily">Diária</option>
        <option value="weekly">Semanal</option>
        <option value="monthly">Mensal</option>
      </select>
      <button onclick="addTask()">Adicionar</button>
      <button onclick="openTaskManager()">Gerenciar Tarefas</button>
    </div>

    <div class="header">
      <button id="prevMonth">◀</button>
      <h2 id="monthYear"></h2>
      <button id="nextMonth">▶</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Dom</th>
          <th>Seg</th>
          <th>Ter</th>
          <th>Qua</th>
          <th>Qui</th>
          <th>Sex</th>
          <th>Sáb</th>
        </tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Gerenciar Tarefas</h3>
        <span class="close" onclick="closeTaskManager()">&times;</span>
      </div>
      <div id="taskList"></div>
    </div>
  </div>

<script>
  const calendarBody = document.getElementById('calendarBody');
  const monthYear = document.getElementById('monthYear');
  const prevMonthBtn = document.getElementById('prevMonth');
  const nextMonthBtn = document.getElementById('nextMonth');

  let currentDate = new Date();
  let currentMonth = currentDate.getMonth();
  let currentYear = currentDate.getFullYear();

  let tasks = JSON.parse(localStorage.getItem('tasks')) || [];

  function saveTasks() {
    localStorage.setItem('tasks', JSON.stringify(tasks));
  }

  function addTask() {
    const date = document.getElementById('taskDate').value;
    const time = document.getElementById('taskTime').value;
    const description = document.getElementById('taskDescription').value;
    const recurring = document.getElementById('taskRecurring').value;

    if (!date || !time || !description) {
      alert('Preencha todos os campos.');
      return;
    }

    tasks.push({ id: Date.now(), date, time, description, recurring });
    saveTasks();
    renderCalendar(currentYear, currentMonth);
    clearForm();
  }

  function clearForm() {
    document.getElementById('taskDate').value = '';
    document.getElementById('taskTime').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskRecurring').value = 'none';
  }

  function deleteTask(id) {
    tasks = tasks.filter(t => t.id !== id);
    saveTasks();
    renderCalendar(currentYear, currentMonth);
    renderTaskManager();
  }

  function editTask(id) {
    const task = tasks.find(t => t.id === id);
    if (task) {
      // Modal edit poderia ser feito aqui, mas por simplicidade usamos prompts
      const newDate = prompt('Data (AAAA-MM-DD):', task.date);
      const newTime = prompt('Hora (HH:MM):', task.time);
      const newDesc = prompt('Descrição:', task.description);
      const newRec = prompt('Recorrência (none, daily, weekly, monthly):', task.recurring);

      if (newDate && newTime && newDesc) {
        task.date = newDate;
        task.time = newTime;
        task.description = newDesc;
        task.recurring = newRec || 'none';
        saveTasks();
        renderCalendar(currentYear, currentMonth);
        renderTaskManager();
      }
    }
  }

  function matchesRecurring(task, dateStr) {
    if (task.date === dateStr) return true;
    const taskDate = new Date(task.date);
    const checkDate = new Date(dateStr);
    if (task.recurring === 'daily') return taskDate <= checkDate;
    if (task.recurring === 'weekly') return taskDate <= checkDate && taskDate.getDay() === checkDate.getDay();
    if (task.recurring === 'monthly') return taskDate <= checkDate && taskDate.getDate() === checkDate.getDate();
    return false;
  }

  function renderCalendar(year, month) {
    calendarBody.innerHTML = '';
    const firstDay = new Date(year, month, 1);
    const startingDay = firstDay.getDay();
    const totalDays = new Date(year, month + 1, 0).getDate();

    const prevMonthDays = startingDay;
    let dayCounter = 1;

    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    const monthNames = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    monthYear.textContent = `${monthNames[month]} ${year}`;

    for (let row = 0; row < 6; row++) {
      const tr = document.createElement('tr');

      for (let i = 0; i < 7; i++) {
        const td = document.createElement('td');
        const dayInMonth = (row * 7 + i >= prevMonthDays) && (dayCounter <= totalDays);

        if (dayInMonth) {
          const dateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(dayCounter).padStart(2,'0')}`;
          td.textContent = dayCounter;

          if (dateStr === todayStr) {
            td.classList.add('today');
          }

          // Filtra tarefas para o dia incluindo recorrentes
          const tasksOnDay = tasks.filter(t => matchesRecurring(t, dateStr));

          if (tasksOnDay.length > 0) {
            td.classList.add('has-task');
            td.style.cursor = 'pointer';

            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerText = tasksOnDay.map(t => `${t.time} - ${t.description}${t.recurring !== 'none' ? ' (Recorrente)' : ''}`).join('\n');
            td.appendChild(tooltip);

            td.addEventListener('mouseenter', () => {
              tooltip.style.display = 'block';
            });
            td.addEventListener('mouseleave', () => {
              tooltip.style.display = 'none';
            });

            td.addEventListener('click', () => {
              alert(`Tarefas em ${dateStr}:\n\n${tasksOnDay.map(t => `${t.time} - ${t.description}${t.recurring !== 'none' ? ' (Recorrente)' : ''}`).join('\n')}`);
            });
          }

          dayCounter++;
        } else {
          td.classList.add('empty');
          td.textContent = '';
        }

        tr.appendChild(td);
      }

      calendarBody.appendChild(tr);
    }
  }

  // Modal management
  const taskModal = document.getElementById('taskModal');
  const taskListDiv = document.getElementById('taskList');

  function openTaskManager() {
    renderTaskManager();
    taskModal.style.display = 'block';
  }
  function closeTaskManager() {
    taskModal.style.display = 'none';
  }
  window.onclick = function(event) {
    if (event.target == taskModal) {
      taskModal.style.display = 'none';
    }
  }

  function renderTaskManager() {
    if (tasks.length === 0) {
      taskListDiv.innerHTML = '<p>Nenhuma tarefa cadastrada.</p>';
      return;
    }

    taskListDiv.innerHTML = '';
    tasks.forEach(task => {
      const div = document.createElement('div');
      div.classList.add('task-item');

      div.innerHTML = `
        <strong>${task.date} ${task.time}</strong> - ${task.description} ${task.recurring !== 'none' ? ` (Recorrente: ${task.recurring})` : ''}
        <div class="task-actions">
          <button class="edit-btn" onclick="editTask(${task.id})">Editar</button>
          <button class="delete-btn" onclick="deleteTask(${task.id})">Excluir</button>
        </div>
      `;

      taskListDiv.appendChild(div);
    });
  }

  // Botões de navegação do calendário
  prevMonthBtn.addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar(currentYear, currentMonth);
  });

  nextMonthBtn.addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar(currentYear, currentMonth);
  });

  // Notificações Push

  if (Notification.permission !== 'granted') {
    Notification.requestPermission();
  }

  setInterval(() => {
    const now = new Date();
    const nowStr = now.toISOString().slice(0, 10);
    const nowTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    tasks.forEach(task => {
      if (matchesRecurring(task, nowStr) && task.time === nowTime) {
        sendNotification(task);
      }
    });
  }, 60000);

  function sendNotification(task) {
    if (Notification.permission === 'granted') {
      new Notification(`Tarefa às ${task.time}`, {
        body: `${task.description}${task.recurring !== 'none' ? ' (Recorrente)' : ''}`,
        icon: 'https://cdn-icons-png.flaticon.com/512/1827/1827565.png'
      });
    }
  }

  // Inicialização
  renderCalendar(currentYear, currentMonth);
</script>
</body>
</html>
